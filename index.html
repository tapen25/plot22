<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Speed Control (Motion-based)</title>
    
    <script src="https://unpkg.com/wavesurfer.js"></script>
    
    <style>
        body { font-family: sans-serif; padding: 20px; max-width: 600px; margin: auto; }
        #waveform { border: 1px solid #ddd; border-radius: 4px; background: #f8f8f8; }
        button { margin: 5px; padding: 10px 15px; font-size: 16px; cursor: pointer; }
        #sensorBtn { background-color: #28a745; color: white; }
        
        .speed-display { margin-top: 15px; }
        #speedValue {
            font-size: 1.5em; /* 大きめに表示 */
            font-weight: bold;
            font-family: monospace;
            color: #007bff;
        }
        #rmsValue {
            font-size: 0.9em;
            font-family: monospace;
            color: #666;
        }
    </style>
</head>
<body>

    <h2>a.mp3 速度変更デモ (加速度センサー連動)</h2>
    <p>
        「センサー開始」を押し、許可を与えた後、
        <strong>スマートフォンを振る強さ</strong>で再生速度が変わります。<br>
        
    </p>

    <div id="waveform"></div>
    <hr>

    <button id="playPauseBtn">Play</button>
    
    <button id="sensorBtn">センサー開始</button>
    
    <div class="speed-display">
        再生速度: <span id="speedValue">1.00x</span><br>
        モーション強度(rms): <span id="rmsValue">0.00</span>
    </div>

    <script>
       // === 1. 基本設定 (変更なし) ===
        const wavesurfer = WaveSurfer.create({
            container: '#waveform', waveColor: 'violet', progressColor: 'purple',
            barWidth: 3, barRadius: 3, cursorWidth: 1, height: 100, barGap: 3
        });
        try { wavesurfer.load('kanon.mp3'); } catch (error) { /* ...エラー処理... */ }
        const playPauseBtn = document.getElementById('playPauseBtn');
        playPauseBtn.onclick = () => wavesurfer.playPause();
        wavesurfer.on('play', () => { playPauseBtn.textContent = 'Pause'; });
        wavesurfer.on('pause', () => { playPauseBtn.textContent = 'Play'; });
        wavesurfer.on('ready', () => { playPauseBtn.textContent = 'Play'; });
        const speedValueDisplay = document.getElementById('speedValue');
        const rmsValueDisplay = document.getElementById('rmsValue');
        const sensorBtn = document.getElementById('sensorBtn');

        // === 2. センサーと平滑化のパラメータ (変更なし) ===
        const windowSize = 15;
        const SMOOTHING_FACTOR = 0.05; // 平滑化係数
        const buffer = [];
        let targetRms = 0.0;
        let currentRms = 0.0;
        let lastAppliedSpeed = 1.0; // 最後に適用した速度（最適化用）
        let isFading = false;       // ★NEW: フェード処理中かどうかのフラグ

        // === 3. 「範囲分け」ロジック (変更なし) ===
        function mapRmsToSpeed(rms) {
            if (rms < 1.0) { return 0.85; }
            else if (rms < 2.0) { return 0.9; }
            else if (rms < 3.0) { return 1.0; }
            else if (rms < 4.0) { return 1.05; }
            else if (rms < 5.0) { return 1.1; }
            else if (rms < 6.0) { return 1.15; }
            else { return 1.2; }
        }

        // === 4. センサーイベントハンドラ (変更なし) ===
        // (高頻度で呼ばれ、targetRmsを更新するだけ)
        function handleMotion(event) {
            const a = event.accelerationIncludingGravity;
            if (!a) return;
            const mag = Math.sqrt(a.x * a.x + a.y * a.y + a.z * a.z);
            buffer.push(mag);
            if (buffer.length > windowSize) buffer.shift();
            if (buffer.length < windowSize) return;
            const mean = buffer.reduce((s, v) => s + v, 0) / buffer.length;
            const rms = Math.sqrt(
                buffer.reduce((s, v) => s + (v - mean) ** 2, 0) / buffer.length
            );
            targetRms = rms; // 目標値を更新
        }

        // === 5. 平滑化 + 速度適用ループ (ロジックを更新) ===

        function smoothUpdate() {
            // (A) 「現在値」を「目標値」にじわじわ近づける (変更なし)
            currentRms = (targetRms * SMOOTHING_FACTOR) + (currentRms * (1.0 - SMOOTHING_FACTOR));
            
            // (B) ★【変更点】★
            // 平滑化された currentRms を、新しい「範囲分け」関数に渡す
            const targetSpeed = mapRmsToSpeed(currentRms);

            // (C) 速度が（本当に）変わった時だけ setPlaybackRate を呼ぶ (変更なし)
            // この最適化が、範囲分けのおかげで非常に効果的になる
            if (targetSpeed !== lastAppliedSpeed && !isFading) {
        
                isFading = true; // 処理開始のフラグを立てる

                // 1. マイクロ・フェードアウト
                wavesurfer.setVolume(0.01); // ほぼゼロにする

                // 2. わずかに待ってから速度を変更 (JSのタイマー)
                // (setVolumeが反映されるのを待つ)
                setTimeout(() => {
                    
                    // 速度を切り替える（これが「プツッ」の原因）
                    wavesurfer.setPlaybackRate(targetSpeed);
                    lastAppliedSpeed = targetSpeed;
                    
                    // UI更新
                    speedValueDisplay.textContent = `${targetSpeed.toFixed(2)}x`;

                    // 3. さらにわずかに待ってから音量を戻す
                    // (setPlaybackRateの処理が内部で完了するのを待つ)
                    setTimeout(() => {
                        
                        // 4. マイクロ・フェードイン
                        wavesurfer.setVolume(1.0);
                        
                        // 5. フラグを解除
                        isFading = false; 

                    }, 30); // 30ミリ秒 (0.03秒) (要調整)

                }, 20); // 20ミリ秒 (0.02秒) (要調整)
            }
            
            // (D) UIの更新 (変更なし)
            rmsValueDisplay.textContent = `(rms: ${currentRms.toFixed(2)})`;
            requestAnimationFrame(smoothUpdate);
        }

        // === 6. センサー開始ボタン (変更なし) ===
        sensorBtn.addEventListener('click', () => {
            // 許可リクエスト
            if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
                // iOS 13+
                DeviceMotionEvent.requestPermission()
                    .then(permissionState => {
                        if (permissionState === 'granted') {
                            window.addEventListener('devicemotion', handleMotion);
                            startApp();
                        } else { alert('センサーが許可されませんでした。'); }
                    })
                    .catch(error => { alert('センサー許可エラー: ' + error.message); });
            } else if ('DeviceMotionEvent' in window) {
                // Android
                window.addEventListener('devicemotion', handleMotion);
                startApp();
            } else {
                alert('お使いのブラウザは加速度センサーに対応していません。');
            }
        });
        function startApp() {
            sensorBtn.textContent = 'センサー動作中';
            sensorBtn.disabled = true;
            requestAnimationFrame(smoothUpdate); // ループ開始
        }
                
    </script>
</body>
</html>