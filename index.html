<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Speed Control (Motion-based)</title>
    
    <script src="https://unpkg.com/wavesurfer.js"></script>
    
    <style>
        body { font-family: sans-serif; padding: 20px; max-width: 600px; margin: auto; }
        #waveform { border: 1px solid #ddd; border-radius: 4px; background: #f8f8f8; }
        button { margin: 5px; padding: 10px 15px; font-size: 16px; cursor: pointer; }
        #sensorBtn { background-color: #28a745; color: white; }
        
        .speed-display { margin-top: 15px; }
        #speedValue {
            font-size: 1.5em; /* 大きめに表示 */
            font-weight: bold;
            font-family: monospace;
            color: #007bff;
        }
        #rmsValue {
            font-size: 0.9em;
            font-family: monospace;
            color: #666;
        }
    </style>
</head>
<body>

    <h2>a.mp3 速度変更デモ (加速度センサー連動)</h2>
    <p>
        「センサー開始」を押し、許可を与えた後、
        <strong>スマートフォンを振る強さ</strong>で再生速度が変わります。<br>
        <strong style="color: red;">※HTTPS接続が必要です</strong>
    </p>

    <div id="waveform"></div>
    <hr>

    <button id="playPauseBtn">Play</button>
    
    <button id="sensorBtn">センサー開始</button>
    
    <div class="speed-display">
        再生速度: <span id="speedValue">1.00x</span><br>
        モーション強度(rms): <span id="rmsValue">0.00</span>
    </div>

    <script>
        // === 1. 基本設定 ===
        
        const wavesurfer = WaveSurfer.create({
            container: '#waveform', waveColor: 'violet', progressColor: 'purple',
            barWidth: 3, barRadius: 3, cursorWidth: 1, height: 100, barGap: 3
        });
        
        try { wavesurfer.load('kanon.mp3'); } catch (error) { /* ...エラー処理... */ }

        // 再生/一時停止ロジック
        const playPauseBtn = document.getElementById('playPauseBtn');
        playPauseBtn.onclick = () => wavesurfer.playPause();
        wavesurfer.on('play', () => { playPauseBtn.textContent = 'Pause'; });
        wavesurfer.on('pause', () => { playPauseBtn.textContent = 'Play'; });
        wavesurfer.on('ready', () => { playPauseBtn.textContent = 'Play'; });

        // UI要素
        const speedValueDisplay = document.getElementById('speedValue');
        const rmsValueDisplay = document.getElementById('rmsValue');
        const sensorBtn = document.getElementById('sensorBtn');

        // === 2. 速度マッピング定義 ===

        // 21段階の速度マップ (前回と同じ)
        const speedMap = [
            0.8, 0.82, 0.84, 0.86, 0.88, 0.9, 0.92, 0.94, 0.96, 
            0.98, 1.0, 1.02, 1.04, 1.06, 1.08, 1.1, 1.12, 1.14,
            1.16, 1.18, 1.2
        ];
        
        // (インデックスの最大値)
        const MAX_INDEX = speedMap.length - 1; // 20

        // === 3. 加速度センサー処理 ===

        // --- 調整用パラメータ ---
        // RMSの想定最大値 (この値で1.2xになります)
        const MAX_RMS_EXPECTED = 10.0;
        // 加速度バッファのサイズ (大きいほど滑らか、小さいほど敏感)
        const windowSize = 15; // 15サンプル分
        // 速度更新の間隔 (ミリ秒) - 処理負荷軽減（スロットリング）
        const UPDATE_INTERVAL_MS = 200; // 0.2秒ごと
        // ---------------------

        const buffer = [];
        let lastUpdateTime = 0;

        // メインの処理: devicemotion イベントハンドラ
        function handleMotion(event) {
            const now = Date.now();
            
            // 1. RMS (標準偏差) の計算 (ご提示のコード)
            const a = event.accelerationIncludingGravity;
            if (!a) return;
            const mag = Math.sqrt(a.x*a.x + a.y*a.y + a.z*a.z);
            buffer.push(mag);
            if (buffer.length > windowSize) buffer.shift();

            if (buffer.length < windowSize) return; // バッファが溜まるまで待つ

            const mean = buffer.reduce((s, v) => s + v, 0) / buffer.length;
            const rms = Math.sqrt(
                buffer.reduce((s, v) => s + (v - mean) ** 2, 0) / buffer.length
            );

            // 2. スロットリング (更新頻度を制限)
            if (now - lastUpdateTime < UPDATE_INTERVAL_MS) {
                return; // まだ更新しない
            }
            lastUpdateTime = now;

            // 3. RMSから速度インデックスへのマッピング
            // (a) RMS値を 0.0 〜 MAX_RMS_EXPECTED の範囲にクランプ(制限)
            const clampedRms = Math.max(0, Math.min(rms, MAX_RMS_EXPECTED));
            
            // (b) 0.0〜1.0 の値に正規化
            const normalizedValue = clampedRms / MAX_RMS_EXPECTED;
            
            // (c) 0〜20 のインデックスに変換し、四捨五入して整数にする
            const targetIndex = Math.round(normalizedValue * MAX_INDEX);

            // 4. 速度の決定と適用
            const speed = speedMap[targetIndex];
            
            wavesurfer.setPlaybackRate(speed);

            // 5. UIの更新
            speedValueDisplay.textContent = `${speed.toFixed(2)}x`;
            rmsValueDisplay.textContent = `${rms.toFixed(2)}`;
        }

        // === 4. センサー開始ボタンのロジック ===

        sensorBtn.addEventListener('click', () => {
            // センサー許可をリクエストする標準的な方法
            if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
                // (主にiOS 13+ 用)
                DeviceMotionEvent.requestPermission()
                    .then(permissionState => {
                        if (permissionState === 'granted') {
                            window.addEventListener('devicemotion', handleMotion);
                            sensorBtn.textContent = 'センサー動作中';
                            sensorBtn.disabled = true;
                        } else {
                            alert('センサーの許可が拒否されました。');
                        }
                    })
                    .catch(error => {
                        alert('センサー許可中にエラーが発生しました: ' + error.message);
                    });
            } else if ('DeviceMotionEvent' in window) {
                // (主にAndroid用、または許可が不要なブラウザ)
                window.addEventListener('devicemotion', handleMotion);
                sensorBtn.textContent = 'センサー動作中';
                sensorBtn.disabled = true;
            } else {
                alert('お使いのブラウザは加速度センサーに対応していません。');
            }
        });
        
    </script>
</body>
</html>