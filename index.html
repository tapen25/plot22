<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Speed Control (Motion-based)</title>
    
    <script src="https://unpkg.com/wavesurfer.js"></script>
    
    <style>
        body { font-family: sans-serif; padding: 20px; max-width: 600px; margin: auto; }
        #waveform { border: 1px solid #ddd; border-radius: 4px; background: #f8f8f8; }
        button { margin: 5px; padding: 10px 15px; font-size: 16px; cursor: pointer; }
        #sensorBtn { background-color: #28a745; color: white; }
        
        .speed-display { margin-top: 15px; }
        #speedValue {
            font-size: 1.5em; /* 大きめに表示 */
            font-weight: bold;
            font-family: monospace;
            color: #007bff;
        }
        #rmsValue {
            font-size: 0.9em;
            font-family: monospace;
            color: #666;
        }
    </style>
</head>
<body>

    <h2>a.mp3 速度変更デモ (加速度センサー連動)</h2>
    <p>
        「センサー開始」を押し、許可を与えた後、
        <strong>スマートフォンを振る強さ</strong>で再生速度が変わります。<br>
        
    </p>

    <div id="waveform"></div>
    <hr>

    <button id="playPauseBtn">Play</button>
    
    <button id="sensorBtn">センサー開始</button>
    
    <div class="speed-display">
        再生速度: <span id="speedValue">1.00x</span><br>
        モーション強度(rms): <span id="rmsValue">0.00</span>
    </div>

    <script>
        // === 1. 基本設定 ===

        const wavesurfer = WaveSurfer.create({
            container: '#waveform', waveColor: 'violet', progressColor: 'purple',
            barWidth: 3, barRadius: 3, cursorWidth: 1, height: 100, barGap: 3
        });

        try { wavesurfer.load('kanon.mp3'); } catch (error) { /* ...エラー処理... */ }

        // 再生/一時停止ロジック
        const playPauseBtn = document.getElementById('playPauseBtn');
        playPauseBtn.onclick = () => wavesurfer.playPause();
        wavesurfer.on('play', () => { playPauseBtn.textContent = 'Pause'; });
        wavesurfer.on('pause', () => { playPauseBtn.textContent = 'Play'; });
        wavesurfer.on('ready', () => { playPauseBtn.textContent = 'Play'; });

        // UI要素
        const speedValueDisplay = document.getElementById('speedValue');
        const rmsValueDisplay = document.getElementById('rmsValue');
        const sensorBtn = document.getElementById('sensorBtn');

        // === 2. 速度マッピング定義 ===

        const speedMap = [
            0.8, 0.82, 0.84, 0.86, 0.88, 0.9, 0.92, 0.94, 0.96,
            0.98, 1.0, 1.02, 1.04, 1.06, 1.08, 1.1, 1.12, 1.14,
            1.16, 1.18, 1.2
        ];
        const MAX_INDEX = speedMap.length - 1; // 20

        // === 3. 加速度センサー処理 ===

        // --- 調整用パラメータ ---
        const MAX_RMS_EXPECTED = 10.0; // このRMS値で 1.2x になる
        const windowSize = 15;
        // ★【NEW】平滑化の係数 (0.01:すごく滑らか/遅い 〜 0.2:敏感/速い)
        const SMOOTHING_FACTOR = 0.05;
        // ---------------------

        const buffer = [];

        // ★【NEW】状態を持つ変数
        let targetRms = 0.0;      // センサーが検出した「目標」のRMS
        let currentRms = 0.0;     // 平滑化された「現在」のRMS
        let lastAppliedSpeed = 1.0; // 最後に適用した速度（最適化用）

        // センサーイベントハンドラ (高頻度で呼ばれる)
        function handleMotion(event) {
            const a = event.accelerationIncludingGravity;
            if (!a) return;
            const mag = Math.sqrt(a.x * a.x + a.y * a.y + a.z * a.z);
            buffer.push(mag);
            if (buffer.length > windowSize) buffer.shift();

            if (buffer.length < windowSize) return;

            const mean = buffer.reduce((s, v) => s + v, 0) / buffer.length;
            const rms = Math.sqrt(
                buffer.reduce((s, v) => s + (v - mean) ** 2, 0) / buffer.length
            );

            // ★【変更点】ここでは setPlaybackRate を呼ばず、目標値(targetRms)を更新するだけ
            targetRms = rms;
        }

        // === 4. 【NEW】平滑化ループ (requestAnimationFrame) ===

        function smoothUpdate() {
            // (A) 「現在値」を「目標値」にじわじわ近づける (Exponential Moving Average)
            // SMOOTHING_FACTOR が小さいほど滑らかになる
            currentRms = (targetRms * SMOOTHING_FACTOR) + (currentRms * (1.0 - SMOOTHING_FACTOR));
            
            // (B) 平滑化された currentRms を使って速度インデックスを計算
            const clampedRms = Math.max(0, Math.min(currentRms, MAX_RMS_EXPECTED));
            const normalizedValue = clampedRms / MAX_RMS_EXPECTED;
            const targetIndex = Math.round(normalizedValue * MAX_INDEX);
            
            // (C) 速度を決定
            const targetSpeed = speedMap[targetIndex];

            // (D) 速度が前回適用したものと実質的に変わった場合のみ、
            //     setPlaybackRate() を呼び出す（処理負荷の最適化）
            //     (toFixed(3) で丸めて比較)
            if (targetSpeed.toFixed(3) !== lastAppliedSpeed.toFixed(3)) {
                wavesurfer.setPlaybackRate(targetSpeed);
                lastAppliedSpeed = targetSpeed; // 適用した速度を記憶
                
                // UIも更新
                speedValueDisplay.textContent = `${targetSpeed.toFixed(2)}x`;
            }
            
            // (おまけ) RMS値のUIだけは毎フレーム更新する
            rmsValueDisplay.textContent = `${currentRms.toFixed(2)} (Target: ${targetRms.toFixed(2)})`;

            // (E) 次のフレームでもこの関数を呼ぶ
            requestAnimationFrame(smoothUpdate);
        }

        // === 5. センサー開始ボタン ===

        sensorBtn.addEventListener('click', () => {
            // 許可リクエスト
            if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
                // iOS 13+
                DeviceMotionEvent.requestPermission()
                    .then(permissionState => {
                        if (permissionState === 'granted') {
                            window.addEventListener('devicemotion', handleMotion);
                            startApp();
                        } else { alert('センサーが許可されませんでした。'); }
                    })
                    .catch(error => { alert('センサー許可エラー: ' + error.message); });
            } else if ('DeviceMotionEvent' in window) {
                // Android
                window.addEventListener('devicemotion', handleMotion);
                startApp();
            } else {
                alert('お使いのブラウザは加速度センサーに対応していません。');
            }
        });

        function startApp() {
            sensorBtn.textContent = 'センサー動作中';
            sensorBtn.disabled = true;
            
            // ★【NEW】平滑化ループを開始する
            requestAnimationFrame(smoothUpdate);
        }
                
    </script>
</body>
</html>